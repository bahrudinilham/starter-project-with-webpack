const CACHE_VERSION="story-explorer-cache-v1",RUNTIME_CACHE="story-explorer-runtime-v1",APP_SHELL=["/","/index.html","/app.bundle.js","/app.css","/manifest.webmanifest","/favicon.png","/offline.html","/images/icons/icon-192.png","/images/icons/icon-512.png"],NOTIFICATION_ICON="/images/icons/icon-192.png",NOTIFICATION_BADGE="/images/icons/icon-192.png",FALLBACK_URL="/#/";async function handleNavigationRequest(t){try{const i=await fetch(t);return(await caches.open(RUNTIME_CACHE)).put("/index.html",i.clone()),i}catch(t){const i=await caches.match("/index.html");return i||(await caches.match("/offline.html")||Response.error())}}async function cacheFirst(t){const i=await caches.match(t);if(i)return i;const e=await fetch(t);return(await caches.open(CACHE_VERSION)).put(t,e.clone()),e}async function staleWhileRevalidate(t){const i=await caches.open(RUNTIME_CACHE),e=await i.match(t),n=fetch(t).then((e=>(i.put(t,e.clone()),e))).catch((()=>e));return e||n}async function showPushNotification(t){try{const i=buildNotificationPayload(t);return self.registration.showNotification(i.title,i.options)}catch(t){return console.error("Failed to display notification",t),self.registration.showNotification("Story Explorer",{body:"Cerita baru siap dibaca.",icon:NOTIFICATION_ICON,badge:NOTIFICATION_BADGE,data:{url:"/#/"}})}}function buildNotificationPayload(t){let i=null;if(t)try{i=t.json()}catch(e){console.warn("Push payload is not valid JSON, fallback to text."),i={title:t.text()}}const e=("string"==typeof i?"Story Explorer":i?.title)||"Story Explorer",n=i?.options||{},a="string"==typeof i?i:i?.body,o=n.body||a||"Cerita baru siap dibaca.",c=n.data||i?.data||{},s=c.url||(c.storyId?`/#/story/${c.storyId}`:"/#/"),l={body:o,icon:n.icon||NOTIFICATION_ICON,badge:n.badge||NOTIFICATION_BADGE,data:{...c,url:s},actions:n.actions&&n.actions.length?n.actions:[{action:"open_story",title:"Lihat detail"}]};return n.image&&(l.image=n.image),n.tag&&(l.tag=n.tag),void 0!==n.renotify&&(l.renotify=n.renotify),void 0!==n.requireInteraction&&(l.requireInteraction=n.requireInteraction),{title:e,options:l}}async function handleNotificationClick(t){const i=await self.clients.matchAll({includeUncontrolled:!0,type:"window"}),e=new URL(t,self.location.origin).href,n=i.find((t=>t.url===e));return n?(n.focus(),"navigate"in n&&n.navigate(e),n):self.clients.openWindow(e)}self.addEventListener("install",(t=>{self.skipWaiting(),t.waitUntil(caches.open(CACHE_VERSION).then((t=>t.addAll(APP_SHELL))).catch((t=>{console.error("Failed to precache app shell",t)})))})),self.addEventListener("activate",(t=>{t.waitUntil(caches.keys().then((t=>Promise.all(t.map((t=>t!==CACHE_VERSION&&t!==RUNTIME_CACHE?caches.delete(t):null))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(t=>{const{request:i}=t;if("GET"!==i.method)return;if("navigate"===i.mode)return void t.respondWith(handleNavigationRequest(i));const e=new URL(i.url);APP_SHELL.includes(e.pathname)?t.respondWith(cacheFirst(i)):e.origin===self.location.origin&&t.respondWith(staleWhileRevalidate(i))})),self.addEventListener("push",(t=>{t.waitUntil(showPushNotification(t.data))})),self.addEventListener("notificationclick",(t=>{if(t.notification.close(),t.action&&"dismiss"===t.action)return;const i=t.notification?.data?.url||"/#/";t.waitUntil(handleNotificationClick(i))})),self.addEventListener("notificationclose",(t=>{console.info("Notification closed",t.notification?.tag)})),self.addEventListener("pushsubscriptionchange",(t=>{console.info("Push subscription change detected."),t.waitUntil(self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then((t=>{t.forEach((t=>t.postMessage({type:"pushsubscriptionchange"})))})))}));